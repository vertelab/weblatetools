#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Vertel translation automation script - SKAPAR PO-filer automatiskt!
"""

import os
import subprocess
import glob
import time
from pathlib import Path
from difflib import unified_diff
import polib

print("üöÄ Skriptet startar...")

# TYDLIGT sudo-meddelande
if os.geteuid() != 0:
    print("‚ùå SKRIPTET Kr√§VER ROOT-R√ÑTTIGHETER!")
    print("üí° K√∂r: sudo ./vertel_translate")
    raise SystemExit(1)

def has_untranslated_entries(po_path):
    """Returnerar True OM det finns tomma/√∂vers√§ttningsbeh√∂vande entries"""
    try:
        po = polib.pofile(str(po_path))
        untranslated_count = 0
        fuzzy_count = 0
        
        for entry in po:
            if entry.msgstr.strip() == "":  # Tom √∂vers√§ttning
                untranslated_count += 1
            if entry.obsolete:  # Obsolete/fuzzy
                fuzzy_count += 1
        
        total_needs_work = untranslated_count + fuzzy_count
        print(f"  üîç {po_path.name}: {untranslated_count} tomma, {fuzzy_count} fuzzy")
        return total_needs_work > 0
    except Exception as e:
        print(f"  ‚ö†Ô∏è Kunde inte l√§sa PO: {e}")
        return True

# KONFIGURATION
VERTEL_DIR = Path("/usr/share/vertel-translate")
BASE_PATH = "/usr/share"
PROJECT_PATTERN = os.path.join(BASE_PATH, "odoo-*")
DB_NAME = "vertel_translate"
LANG = "sv"

LOG_FILES = {
    "ok": "ok_modules.log",
    "fail": "failed_modules.log", 
    "new": "new_translations.log",
    "missing": "missing_translations.log",
    "time": "execution_times.log",
    "summary": "project_summary.log",
}

# INITIERING
print(f"üöÄ Startar Vertel Translator i {VERTEL_DIR}")

# SKAPA/Rensa loggar
for f in LOG_FILES.values():
    log_path = VERTEL_DIR / f
    try:
        if log_path.exists():
            log_path.unlink()
        log_path.touch()
        print(f"üìù Logg OK: {log_path.name}")
    except Exception as e:
        print(f"‚ùå Loggfels {log_path.name}: {e}")
        raise SystemExit(1)

# Rensa gamla PO-filer
for f in VERTEL_DIR.glob("*.po"):
    f.unlink(missing_ok=True)

log_ok = open(VERTEL_DIR / LOG_FILES["ok"], "a")
log_fail = open(VERTEL_DIR / LOG_FILES["fail"], "a")
log_new = open(VERTEL_DIR / LOG_FILES["new"], "a")
log_missing = open(VERTEL_DIR / LOG_FILES["missing"], "a")
log_time = open(VERTEL_DIR / LOG_FILES["time"], "a")
log_summary = open(VERTEL_DIR / LOG_FILES["summary"], "a")

# HUVUDLOOP
for project_path_str in glob.glob(PROJECT_PATTERN):
    project_path = Path(project_path_str)
    project_name = project_path.name
    print(f"\n--- üì¶ Project: {project_name} ---")
    
    modules = []
    for item in project_path.iterdir():
        if item.is_dir() and (item / "__manifest__.py").exists():
            modules.append(item.name)
    
    if not modules:
        print(f"  ‚ÑπÔ∏è Inga moduler i {project_name}")
        continue
    
    project_ok = 0
    project_fails = 0
    project_times = []
    
    for module_name in modules:
        module_path = project_path / module_name
        start_time = time.time()
        print(f"  üß™ {module_name} (cwd={module_path})...")
        
        cmd = [
            'bash', '/usr/local/bin/checkmodule',
            '-d', 'vertel_translate',
            '-m', f'base,{module_name}',
            '-e', '-L', 'sv', '--drop'
        ]
        
        try:
            result = subprocess.run(cmd, cwd=module_path, capture_output=True, text=True, timeout=60)
            elapsed = time.time() - start_time
            
            if result.returncode != 0:
                print(f"  ‚ùå checkmodule fel ({module_name}):")
                print(f"    STDOUT: {result.stdout.strip()}")
                print(f"    STDERR: {result.stderr.strip()}")
            
            source_po = module_path / 'i18n' / 'sv.po'
            target_po = VERTEL_DIR / f"{module_name}.po"

            if source_po.exists():
                size_kb = source_po.stat().st_size / 1024
                target_po.write_bytes(source_po.read_bytes())
                
                print(f"  ‚è±Ô∏è {module_name}: {elapsed:.1f}s ({size_kb:.1f}KB)")
                project_times.append(elapsed)

                # NY LOGIK: Kolla om √∂vers√§ttning beh√∂vs!
                if has_untranslated_entries(target_po):
                    print(f"  üìÑ {module_name}.po BEH√ñVER √ñVERS√ÑTTNING - SPARAD!")
                    project_fails += 1
                    log_new.write(f"{project_name}/{module_name}: BEH√ñVER √ñVERS√ÑTTNING\n")
                else:
                    print(f"  üóëÔ∏è {module_name}.po FULLT √ñVERS√ÑTTAD - RADERAD!")
                    target_po.unlink()
                    project_ok += 1
                    log_ok.write(f"{project_name}/{module_name}: FULLST√ÑNDIG\n")
            else:
                print(f"  ‚ö†Ô∏è {module_name}: Ingen sv.po skapad")
                log_missing.write(f"{project_name}/{module_name}: INGEN PO\n")
                project_fails += 1

        except subprocess.TimeoutExpired:
            print(f"  ‚è∞ {module_name}: TIMEOUT!")
            project_fails += 1
        except Exception as e:
            print(f"  ‚ùå {module_name}: {e}")
            project_fails += 1

    # Sammanfattning
    avg_time = sum(project_times) / len(project_times) if project_times else 0.0
    print(f"üìä {project_name}: {project_ok}/{len(modules)} OK, {project_fails} FAILS, avg {avg_time:.1f}s")
    log_summary.write(f"{project_name}: {project_ok}/{len(modules)} OK, {project_fails} FAILS\n")

# St√§ng loggar
for f in [log_ok, log_fail, log_new, log_missing, log_time, log_summary]:
    f.close()

print(f"\nüéâ KLART! Kolla PO-filer i {VERTEL_DIR}")
print("üìÑ poedit *.po  # √ñvers√§tt r√∂da!")
