#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Vertel translation automation script - SKAPAR PO-filer automatiskt!
"""

import os
import subprocess
import glob
import time
from pathlib import Path
from difflib import unified_diff
import polib  # ‚Üê SAKNADES!

print("üöÄ Skriptet startar...")

if os.geteuid() != 0:
    raise SystemExit(1)

def are_po_files_identical(po1_path, po2_path):
    """J√§mf√∂r tv√• PO-filer - identiska eller inte?"""
    try:
        po1 = polib.pofile(str(po1_path))
        po2 = polib.pofile(str(po2_path))
        
        # Samma antal entries?
        if len(po1) != len(po2):
            return False
        
        # Samma msgid + msgstr f√∂r alla?
        for entry1, entry2 in zip(sorted(po1, key=lambda e: e.msgid), 
                                sorted(po2, key=lambda e: e.msgid)):
            if (entry1.msgid != entry2.msgid or 
                entry1.msgstr.strip() != entry2.msgstr.strip()):
                return False
        
        return True
    except:
        return False


# KONFIGURATION ‚Üê SAKNADES!
VERTEL_DIR = Path("/usr/share/vertel-translate")
BASE_PATH = "/usr/share"
PROJECT_PATTERN = os.path.join(BASE_PATH, "odoo-*")
DB_NAME = "vertel_translate"
LANG = "info"

LOG_FILES = {
    "ok": "ok_modules.log",
    "fail": "failed_modules.log",
    "new": "new_translations.log",
    "time": "execution_times.log",
    "summary": "project_summary.log",
}

def is_module_dir(project_path, name):
    full = os.path.join(project_path, name)
    return os.path.isdir(full) and os.path.exists(os.path.join(full, "__manifest__.py"))

def count_lines_and_size(file_path):
    try:
        with open(file_path, "r", encoding="utf-8") as f:
            return len(f.readlines()), os.path.getsize(file_path) / 1024
    except:
        return 0, 0

def count_blank_translations(po_file_path):
    blank_count = 0
    try:
        with open(po_file_path, "r", encoding="utf-8") as f:
            for line in f:
                if line.strip().startswith('msgstr ""'):
                    blank_count += 1
    except:
        pass
    return blank_count

def compare_files(file1, file2, max_diff=4):
    try:
        with open(file1, "r", encoding="utf-8") as f1, open(file2, "r", encoding="utf-8") as f2:
            lines1 = f1.readlines()
            lines2 = f2.readlines()
    except FileNotFoundError:
        return 9999, True
    diff = list(unified_diff(lines1, lines2))
    return len(diff), len(diff) > max_diff

# INITIERING
print(f"üöÄ Startar Vertel Translator i {VERTEL_DIR}")

# Rensa loggar
for f in LOG_FILES.values():
    log_path = VERTEL_DIR / f
    if log_path.exists():
        log_path.unlink()

# Rensa gamla PO-filer
for f in VERTEL_DIR.glob("*.po"):
    f.unlink(missing_ok=True)

log_ok = open(VERTEL_DIR / LOG_FILES["ok"], "a")
log_fail = open(VERTEL_DIR / LOG_FILES["fail"], "a")
log_new = open(VERTEL_DIR / LOG_FILES["new"], "a")
log_missing = open(VERTEL_DIR / LOG_FILES["saknas"], "a")
log_time = open(VERTEL_DIR / LOG_FILES["time"], "a")
log_summary = open(VERTEL_DIR / LOG_FILES["summary"], "a")

# HUVUDLOOP - K√ñR I VARJE MODULMAPP!
for project_path_str in glob.glob(PROJECT_PATTERN):
    project_path = Path(project_path_str)
    project_name = project_path.name
    print(f"\n--- üì¶ Project: {project_name} ---")
    
    # Lista moduler i projektet (endast mappar med __manifest__.py)
    modules = []
    for item in project_path.iterdir():
        if item.is_dir() and (item / "__manifest__.py").exists():
            modules.append(item.name)
    
    if not modules:
        print(f"  ‚ÑπÔ∏è Inga moduler i {project_name}")
        continue
    
    project_ok = 0
    project_fails = 0
    project_times = []
    
    
    for module_name in modules:
        module_path = project_path / module_name
        start_time = time.time()
        print(f"  üß™ {module_name} (cwd={module_path})...")
        
        # K√∂r checkmodule - skapar i18n/sv.po!
        cmd = [
            'bash', '/usr/local/bin/checkmodule',
            '-d', 'vertel_translate',
            '-m', f'base,{module_name}',  # BASE obligatoriskt!
            '-e', '-L', 'sv', '--drop'    # Export + svenska + rensa!
        ]
        
        try:
            result = subprocess.run(
                cmd, cwd=module_path, capture_output=True, text=True, timeout=30
            )
            elapsed = time.time() - start_time
            
            # KOPIERA f√§rdig sv.po fr√•n checkmodule!
            source_po = module_path / 'i18n' / 'sv.po'
            target_po = VERTEL_DIR / f"{module_name}.po"

            if source_po.exists():
                target_po.write_bytes(source_po.read_bytes())
                size_kb = source_po.stat().st_size / 1024
                print(f"  ‚è±Ô∏è  {module_name}: {elapsed:.1f}s")
                print(f"  üìÑ KOPIERAD: {module_name}.po ({size_kb:.1f} KB)")
                
                # J√ÑMF√ñR med befintlig
                existing_module_po = module_path / 'i18n' / 'sv.po.existing'
                module_po_path = module_path / 'i18n' / 'sv.po'
                
                if module_po_path.exists():
                    if are_po_files_identical(target_po, module_po_path):
                        print(f"  üóëÔ∏è  {module_name}.po IDENTISK - RADERAD!")
                        target_po.unlink()
                        project_ok += 1
                        log_ok.write(f"{project_name}/{module_name}: OK\n") 
                    else:
                        print(f"  ‚ö†Ô∏è  {module_name}.po BEH√ñVER UPPDATERING!")
                        module_po_path.rename(existing_module_po)
                        source_po.copy2(module_po_path)
                        project_fails += 1
                        log_fail.write(f"{project_name}/{module_name}: BEH√ñVER UPPDATERING\n")
                        with open(VERTEL_DIR / 'needs_work.log', 'a') as f:
                            f.write(f"{project_name}/{module_name}: BEH√ñVER √ñVERS√ÑTTNING\n")
                else:
                    print(f"  üìÑ {module_name}: NY!")
                    project_fails += 1
                    log_new.write(f"{project_name}/{module_name}: NY\n")
            else:
                print(f"  ‚ö†Ô∏è  {module_name}: Ingen sv.po")
                project_fails += 1
                log_missing.write(f"{project_name}/{module_name}: sv.po-fil saknas\n")
                
        except subprocess.TimeoutExpired:
            print(f"  ‚è∞ {module_name}: TIMEOUT!")
            project_fails += 1
        except subprocess.CalledProcessError:
            print(f"  ‚ùå {module_name}: FEL!")
            project_fails += 1
        except Exception as e:
            print(f"  ‚ùå {module_name}: {e}")
            project_fails += 1


    # Project-sammanfattning
    avg_time = sum(project_times) / len(project_times) if project_times else 0.0
    print(f"üìä {project_name}: {project_ok}/{len(modules)} OK, {project_fails} FAILS, avg {avg_time:.1f}s")
    
    with open(VERTEL_DIR / 'project_summary.log', 'a') as f:
        f.write(f"{project_name}: {project_ok}/{len(modules)} OK, {project_fails} FAILS\n")

# ST√ÑNG LOGGAR
for f in [log_ok, log_fail, log_new, log_missing, log_time, log_summary]:
    f.close()

print(f"\nüéâ KLART! Kolla PO-filer i {VERTEL_DIR}")
print("üìÑ poedit *.po  # √ñvers√§tt r√∂da!")
