#!/usr/bin/python3
import argparse
import base64
import requests
from pathlib import Path
import polib
import re
import subprocess
import sys
import os
from datetime import datetime
import time


def compare_official_vs_github(official_str, github_str, version, module):
    """J√§mf√∂r OFFICIELL Odoo vs DIN GitHub - NOTERA f√∂r√§ndringar."""
    diff_dir = Path('/usr/share/odoosa-translate')
    
    try:
        official_po = polib.pofile(official_str)
        github_po = polib.pofile(github_str)
        
        # NYA i Odoo (saknas i din GitHub)
        new_in_official = []
        # TA bort fr√•n din GitHub (saknas i Odoo)
        removed_from_github = []
        # √Ñndrade i Odoo
        changed_in_official = []
        
        github_dict = {e.msgid: e for e in github_po}
        official_dict = {e.msgid: e for e in official_po}
        
        print(f"üîç {module}: OFFICIELL vs DIN GitHub")
        
        # NYA i Odoo!
        for msgid, entry in official_dict.items():
            if msgid not in github_dict:
                new_in_official.append(entry.msgid)
        
        # Borttagna fr√•n din GitHub!
        for msgid in github_dict:
            if msgid not in official_dict:
                removed_from_github.append(msgid)
        
        # √Ñndrade msgstr!
        for msgid, github_entry in github_dict.items():
            if msgid in official_dict:
                official_entry = official_dict[msgid]
                if (official_entry.msgstr.strip() != github_entry.msgstr.strip() and 
                    github_entry.msgstr.strip()):
                    changed_in_official.append((msgid, github_entry.msgstr, official_entry.msgstr))
        
        # SKAPA rapport-fil!
        report_path = diff_dir / f"{version}-{module}-changes.po"
        
        with open(report_path, 'w', encoding='utf-8') as f:
            f.write(f"# ODOO OFFICIELLA √ÑNDRINGAR vs DIN GitHub\n")
            f.write(f"# Modul: {module} - {datetime.now()}\n\n")
            
            if new_in_official:
                f.write(f"# üÜï NYA i Odoo ({len(new_in_official)}):\n")
                for msgid in new_in_official[:10]:  # F√∂rsta 10
                    f.write(f'#: msgid "{msgid[:60]}"\n')
                f.write("\n")
            
            if removed_from_github:
                f.write(f"# üóëÔ∏è BORTTAGNA fr√•n din GitHub ({len(removed_from_github)}):\n")
                for msgid in removed_from_github[:10]:
                    f.write(f'#: msgid "{msgid[:60]}"\n')
                f.write("\n")
            
            if changed_in_official:
                f.write(f"# üîÑ √ÑNDRade i Odoo ({len(changed_in_official)}):\n")
                for msgid, din, odoo in changed_in_official[:5]:
                    f.write(f'#: msgid "{msgid[:50]}"\n')
                    f.write(f'# DIN: "{din[:30]}" ‚Üí ODOO: "{odoo[:30]}"\n')
        
        print(f"üìã RAPPORT: {report_path}")
        print(f"   üÜï NYA i Odoo: {len(new_in_official)}")
        print(f"   üóëÔ∏è Borttagna: {len(removed_from_github)}")
        print(f"   üîÑ √Ñndrade: {len(changed_in_official)}")
        
        return {
            'new': new_in_official,
            'removed': removed_from_github,
            'changed': changed_in_official,
            'report_path': report_path
        }
        
    except Exception as e:
        print(f"‚ö†Ô∏è J√§mf√∂relsefel {module}: {e}")
        return None

def detect_odoo_version():
    """Auto-detekt Odoo version."""
    for cmd in ["odoo-bin --version", "odoo --version"]:
        try:
            result = subprocess.run(cmd.split(), capture_output=True, text=True, timeout=10)
            match = re.search(r'(\d+)', result.stdout)
            if match:
                return f"odoo-{match.group(1)}"
        except:
            pass
    return "odoo-18"

def find_github_files(version):
    """H√§mtar alla odoo-*-*.po fr√•n GitHub API."""
    url = "https://api.github.com/repos/vertelab/odoosa-translate/git/trees/main?recursive=1"
    resp = requests.get(url)
    resp.raise_for_status()
    data = resp.json()
    
    files = []
    pattern = re.compile(rf'^{version}-([a-z0-9_-]+)-sv\.po$')
    
    for item in data["tree"]:
        if item["type"] == "blob" and pattern.search(item["path"]):
            match = pattern.search(item["path"])
            files.append({
                'path': item["path"],
                'module': match.group(1),
                'sha': item["sha"]
            })
    
    print(f"‚úÖ GitHub: {len(files)} filer: {[f['module'] for f in files]}")
    return files

def download_github_po(sha):
    """GitHub .po med rate limit hantering."""
    url = f"https://api.github.com/repos/vertelab/odoosa-translate/git/blobs/{sha}"
    for attempt in range(3):
        try:
            resp = requests.get(url)
            resp.raise_for_status()
            blob = resp.json()
            return base64.b64decode(blob["content"]).decode("utf-8")
        except requests.exceptions.HTTPError as e:
            if resp.status_code == 403:
                print(f"‚è≥ GitHub rate limit! V√§ntar {60*attempt+10}s...")
                time.sleep(60*attempt + 10)
                continue
            raise
    raise Exception("GitHub rate limit - prova igen om 1h!")

def download_official_odoo_po(version, module):
    """Ladda OFFICIELL Odoo sv.po fr√•n GitHub - DYNAMISK version."""
    odoo_version = version.replace("odoo-", "") + ".0"
    url = f"https://raw.githubusercontent.com/odoo/odoo/{odoo_version}/addons/{module}/i18n/sv.po"
    
    print(f"   üåê OFFICIELL: {module}")
    
    try:
        resp = requests.get(url, timeout=10)
        resp.raise_for_status()
        
        diff_dir = Path('/usr/share/odoosa-translate')
        official_path = diff_dir / f"{version}-{module}-official.po"
        
        with open(official_path, 'w', encoding='utf-8') as f:
            f.write(resp.text)
        
        print(f"      ‚úÖ {official_path.name}")
        return resp.text
        
    except Exception as e:
        print(f"      ‚ö†Ô∏è OFFICIELL {module}: {e}")
        return None

def sync_odoo(github_str, module):
    """Synkar till core-odoo."""
    local_path = Path('/usr/share/core-odoo/addons') / module / 'i18n' / 'sv.po'
    github_po = polib.pofile(github_str)
    
    translated = len([e for e in github_po if e.msgstr.strip()])
    github_po.save(str(local_path))
    print(f"‚úÖ SYNC: {translated} √∂vers√§ttningar ‚Üí {local_path}")


def git_commit_and_push(repo_dir="/usr/share/core-odoo"):
    """Commitar och pushar √∂vers√§ttningar automatiskt till repo."""
    try:
        print("üì§ PUSHA √§ndringar till git...")
        subprocess.run(["git", "-C", repo_dir, "add", "."], check=True)
        msg = f"Auto-sync {datetime.now().strftime('%Y-%m-%d %H:%M')}"
        subprocess.run(["git", "-C", repo_dir, "commit", "-m", msg], check=True)
        subprocess.run(["git", "-C", repo_dir, "push"], check=True)
        print("‚úÖ Git push klar!")
    except subprocess.CalledProcessError as e:
        print(f"‚ö†Ô∏è Git-fel: {e}")
    except Exception as ex:
        print(f"‚ö†Ô∏è Kunde inte pusha till git: {ex}")
        

def create_diff_always(github_str, official_str, version, module):
    """Diff mot OFFICIELL Odoo."""
    diff_dir = Path('/usr/share/odoosa-translate')
    diff_dir.mkdir(exist_ok=True)
    
    try:
        github_po = polib.pofile(github_str)
        official_po = polib.pofile(official_str) if official_str else polib.POFile()
        
        diff_po = polib.POFile()
        changes = []
        
        print(f"üîç {module}: {len(github_po)} DIN vs {len(official_po)} OFFICIELL")
        
        for entry in github_po:
            if entry.msgstr.strip():
                official_entry = official_po.find(entry.msgid)
                if (not official_entry or 
                    official_entry.msgstr.strip() != entry.msgstr.strip()):
                    orig_str = official_entry.msgstr.strip() if official_entry and official_entry.msgstr.strip() else "(saknas)"
                    changes.append((entry.msgid, orig_str, entry.msgstr))
                    diff_entry = polib.POEntry(msgid=entry.msgid, msgstr=entry.msgstr)
                    diff_po.append(diff_entry)
        
        if changes:
            diff_po.metadata = {
                'Project-Id-Version': f'{version}-{module}',
                'POT-Creation-Date': datetime.now().strftime('%Y-%m-%d %H:%M'),
                'PO-Revision-Date': datetime.now().strftime('%Y-%m-%d %H:%M'),
                'Last-Translator': 'odoosa-translate',
                'Language': 'sv',
                'MIME-Version': '1.0',
                'Content-Type': 'text/plain; charset=UTF-8'
            }
            
            diff_path = diff_dir / f"{version}-{module}-diff.po"
            diff_po.save(str(diff_path))
            print(f"üìÑ DIFF: {diff_path} ({len(changes)} √ÑNDRINGAR)")
            print("üìã √ÑNDRINGAR:")
            for msgid, orig, din in changes[:3]:
                print(f"   {msgid[:40]:40} | {orig[:15]:15} ‚Üí {din[:15]}")
        else:
            print(f"‚ÑπÔ∏è Inga skillnader {module}")
            
    except Exception as e:
        print(f"‚ö†Ô∏è Skip diff {module}: {str(e)[:60]}")

def main():
    import os
    parser = argparse.ArgumentParser(description="Odoo-√∂vers√§ttningsscript")
    parser.add_argument("--auto", action="store_true", help="K√∂r allt utan fr√•gor")
    parser.add_argument("--no-sync", action="store_true", help="Hoppa √∂ver sync + git push")
    args = parser.parse_args()
   
    if os.geteuid() != 0:
        print("üîí Kr√§ver sudo...")
        os.execvp("sudo", ["sudo", sys.executable, __file__])
    
    print("üöÄ ODOSUPER: OFFICIELL + DIFF ‚Üí SYNC!")
    version = detect_odoo_version()
    print(f"üì¶ Odoo version: {version}")
    
    files = find_github_files(version)
    print(f"\n{'='*60}")
    print(f"üöÄ OFFICIELL + DIFF f√∂r {len(files)} moduler!\n")
    
    # SKAPA + RENSA diff-mapp - ALLA filer!
    diff_dir = Path('/usr/share/odoosa-translate')
    diff_dir.mkdir(exist_ok=True)

    old_files = list(diff_dir.glob('*'))
    if old_files:
        for old_file in old_files:
            old_file.unlink()
        print(f"üßπ RENSAT {len(old_files)} gamla filer - NY START!")
    else:
        print("üßπ Mapp tom - k√∂r ig√•ng!")

    # STEG 0: Ladda OFFICIELLA Odoo-filer
    print(f"\n{'='*60}")
    print("üåê STEG 0: LADDAR OFFICIELLA ODOO-FILER...")
    official_files = {}
    
    for file_info in files:
        module = file_info['module']
        official_str = download_official_odoo_po(version, module)
        if official_str:
            official_files[module] = official_str
    
    # STEG 1: SKAPA DIFF-FILER
    print(f"\n{'='*60}")
    print("üìã STEG 1: SKAPAR DIFF-FILER...")
    github_files = {}
    
    for file_info in files:
        module = file_info['module']
        print(f"{'='*50}")
        print(f"üîÑ MODUL: {module}")
        
        github_str = download_github_po(file_info['sha'])
        create_diff_always(github_str, official_files.get(module), version, module)
        github_files[module] = github_str
        print()
    
    # VISA DIFF-FILER
    print(f"\n{'='*60}")
    print("üìÇ DIFF-FILER SKAPADE:")
    diff_count = 0
    for diff_file in diff_dir.glob('*.po'):
        size = diff_file.stat().st_size
        print(f"   üìÑ {diff_file.name} ({size/1000:.1f} KB)")
        diff_count += 1
    
    if diff_count == 0:
        print("‚ÑπÔ∏è Inga √§ndringar ‚Üí hoppar √∂ver sync!")
        return
    
    # STEG 2: J√§mf√∂r OFFICIELL vs DIN GitHub
    print(f"\n{'='*60}")
    print("üîç STEG 3: OFFICIELLA ODOO √ÑNDRINGAR...")
    changes_summary = {}

    for file_info in files:
        module = file_info['module']
        if module in official_files and module in github_files:
            print(f"{'='*50}")
            print(f"üîç J√ÑMF√ñR: {module}")
            changes = compare_official_vs_github(
                official_files[module], 
                github_files[module], 
                version, 
                module
            )
            if changes:
                changes_summary[module] = changes

    # FR√ÖGA OM DU VILL REDIGERA!
    print(f"\n{'='*60}")
    if not args.auto:
        print("‚ùì ODOO har √ÑNDRINGAR! Vill du redigera dina filer f√∂rst? (y/n)")
        edit_answer = input("‚Üí ").lower().strip()
    else:
        edit_answer = 'n'

    if edit_answer in ['y', 'ja', 'yes', 'j']:
        print("\n‚è≥ √ñPPNA rapport-filer i PoEdit och redigera dina GitHub-filer!")
        print(f"üìÇ Kolla: {diff_dir}/odoo-18-*-changes.po")
        print("K√∂r scriptet igen n√§r du √§r klar!")
        return  # Avbryt - du redigerar manuellt!

    # Forts√§tt med sync-fr√•gan...

    # FR√ÖGA OM SYNC
    print(f"\n{'='*60}")
    if not args.auto:
        print("‚ùì SKA SYNCA dina √§ndringar till Odoo? (y/n)")
        answer = input("‚Üí ").lower().strip()
    else:
        answer = "y" if not args.no_sync else "n"


    
    if answer in ['y', 'ja', 'yes', 'j']:
        print("\nüöÄ STEG 2: SYNKAR till Odoo...")
        for module, github_str in github_files.items():
            print(f"{'='*50}")
            print(f"üîÑ SYNC: {module}")
            sync_odoo(github_str, module)
        print("‚úÖ ALLT SYNkat!")
        if not args.no_sync:
            git_commit_and_push()
    else:
        print("‚èπÔ∏è Sync avbruten - filer kvar f√∂r kontroll!")
    
    print(f"\nüìÇ Filer finns h√§r: {diff_dir}")

if __name__ == "__main__":
    main()
